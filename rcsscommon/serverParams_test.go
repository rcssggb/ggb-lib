package rcsscommon

import (
	"fmt"
	"testing"
)

func TestDefaultServerParams(t *testing.T) {
	sp := DefaultServerParams()

	expectedData := ServerParams{
		AudioCutDist:              50,
		AutoMode:                  false,
		BackDashRate:              0.6,
		BackPasses:                true,
		BallAccelMax:              2.7,
		BallDecay:                 0.94,
		BallRand:                  0.05,
		BallSize:                  0.085,
		BallSpeedMax:              3,
		BallStuckArea:             3,
		BallWeight:                0.2,
		CatchBanCycle:             5,
		CatchProbability:          1,
		CatchableAreaL:            1.2,
		CatchableAreaW:            1,
		CKickMargin:               1,
		CLangAdviceWin:            1,
		CLangDefineWin:            1,
		CLangDelWin:               1,
		CLangInfoWin:              1,
		CLangMessDelay:            50,
		CLangMessPerCycle:         1,
		CLangMetaWin:              1,
		CLangRuleWin:              1,
		CLangWinSize:              300,
		Coach:                     false,
		CoachMsgFile:              "",
		CoachPort:                 6001,
		CoachWReferee:             false,
		ConnectWait:               300,
		ControlRadius:             2,
		DashAngleStep:             1,
		DashPowerRate:             0.006,
		DropBallTime:              100,
		EffortDec:                 0.005,
		EffortDecThr:              0.3,
		EffortInc:                 0.01,
		EffortIncThr:              0.6,
		EffortInit:                1,
		EffortMin:                 0.6,
		ExtraHalfTime:             100,
		ExtraStamina:              50,
		FixedTeamnameL:            "",
		FixedTeamnameR:            "",
		ForbidKickOffOffside:      true,
		FoulCycles:                5,
		FoulDetectProbability:     0.5,
		FoulExponent:              10,
		FreeKickFaults:            1,
		FreeformSendPeriod:        20,
		FreeformWaitPeriod:        600,
		FullstateL:                false,
		FullstateR:                false,
		GameLogCompression:        false,
		GameLogDated:              true,
		GameLogDir:                "/root/logs",
		GameLogFixed:              false,
		GameLogFixedName:          "rcssserver",
		GameLogVersion:            5,
		GameLogging:               true,
		GameOverWait:              100,
		GoalWidth:                 14.02,
		GoalieMaxMoves:            2,
		GoldenGoal:                false,
		HalfTime:                  300,
		HearDecay:                 1,
		HearInc:                   1,
		HearMax:                   1,
		IllegalDefenseDistX:       16.5,
		IllegalDefenseDuration:    20,
		IllegalDefenseNumber:      0,
		IllegalDefenseWidth:       40.32,
		InertiaMoment:             5,
		Keepaway:                  false,
		KeepawayLength:            20,
		KeepawayLogDated:          true,
		KeepawayLogDir:            "./",
		KeepawayLogFixed:          false,
		KeepawayLogFixedName:      "rcssserver",
		KeepawayLogging:           true,
		KeepawayStart:             -1,
		KeepawayWidth:             20,
		KickOffWait:               100,
		KickPowerRate:             0.027,
		KickRand:                  0.1,
		KickRandFactorL:           true,
		KickRandFactorR:           true,
		KickableMargin:            0.7,
		LandmarkFile:              "~/.rcssserver-landmark.xml",
		LogDateFormat:             "%Y%m%d%H%M%S-",
		LogTimes:                  false,
		MaxBackTacklePower:        100,
		MaxDashAngle:              180,
		MaxDashPower:              100,
		MaxGoalKicks:              3,
		MaxTacklePower:            100,
		MaxMoment:                 180,
		MaxMonitors:               -1,
		MaxNeckAng:                90,
		MaxNeckMoment:             180,
		MaxPower:                  100,
		MinDashAngle:              -180,
		MinDashPower:              -100,
		MinMoment:                 -180,
		MinNeckAng:                -90,
		MinNeckMoment:             -180,
		MinPower:                  -100,
		NrExtraHalfs:              2,
		NrNormalHalfs:             2,
		OffsideActiveAreaSize:     2.5,
		OffsideKickMargin:         9.15,
		OnlineCoachPort:           6002,
		OldCoachHear:              false,
		PenAllowMultKicks:         true,
		PenBeforeSetupWait:        10,
		PenCoachMovesPlayers:      true,
		PenDistX:                  42.5,
		PenMaxExtraKicks:          5,
		PenMaxGoalieDistX:         14,
		PenNrKicks:                5,
		PenRandomWinner:           false,
		PenReadyWait:              10,
		PenSetupWait:              70,
		PenTakenWait:              150,
		PenaltyShootOuts:          true,
		PlayerAccelMax:            1,
		PlayerDecay:               0.4,
		PlayerRand:                0.1,
		PlayerSize:                0.3,
		PlayerSpeedMax:            1.05,
		PlayerSpeedMaxMin:         0.75,
		PlayerWeight:              60,
		PointToBan:                5,
		PointToDuration:           20,
		Port:                      6000,
		PRandFactorL:              1,
		PRandFactorR:              1,
		Profile:                   0,
		ProperGoalKicks:           0,
		QuantizeStep:              0.1,
		QuantizeStepL:             0.01,
		RecordMessages:            false,
		RecoverDec:                0.002,
		RecoverDecThr:             0.3,
		RecoverInit:               1,
		RecoverMin:                0.5,
		RecvStep:                  10,
		RedCardProbability:        0,
		SayCoachCountMax:          128,
		SayCoachMsgSize:           128,
		SayMsgSize:                10,
		SendComms:                 0,
		SendStep:                  150,
		SendViStep:                100,
		SenseBodyStep:             100,
		SideDashRate:              0.4,
		SimulatorStep:             100,
		SlowDownFactor:            1,
		SlownessOnTopForLeftTeam:  true,
		SlownessOnTopForRightTeam: true,
		StaminaCapacity:           130600,
		StaminaIncMax:             45,
		StaminaMax:                8000,
		StartGoalL:                0,
		StartGoalR:                0,
		StoppedBallVel:            0.01,
		SynchMicroSleep:           1,
		SynchMode:                 false,
		SynchOffset:               60,
		SynchSeeOffset:            0,
		TackleBackDist:            0,
		TackleCycles:              10,
		TackleDist:                2,
		TackleExponent:            6,
		TacklePowerRate:           0.027,
		TackleRandFactor:          2,
		TackleWidth:               1.25,
		TeamActuatorNoise:         0,
		TeamLStart:                "",
		TeamRStart:                "",
		TextLogCompression:        false,
		TextLogDated:              true,
		TextLogDir:                "/root/logs",
		TextLogFixed:              false,
		TextLogFixedName:          "rcssserver",
		TextLogging:               true,
		UseOffside:                true,
		Verbose:                   false,
		VisibleAngle:              90,
		VisibleDistance:           3,
		WindAng:                   0,
		WindDir:                   0,
		WindForce:                 0,
		WindNone:                  false,
		WindRand:                  0,
		WindRandom:                0,
	}

	if sp != expectedData {
		t.Fail()
	}
}

func TestServerParams(t *testing.T) {
	sp := DefaultServerParams()
	errCh := make(chan string, 32)

	sp.Parse(
		"(server_param (audio_cut_dist 50)(auto_mode 0)(back_dash_rate 0.6)(back_passes 1)(ball_accel_max 2.7)(ball_decay 0.94)(ball_rand 0.05)(ball_size 0.085)(ball_speed_max 3)(ball_stuck_area 3)(ball_weight 0.2)(catch_ban_cycle 5)(catch_probability 1)(catchable_area_l 1.2)(catchable_area_w 1)(ckick_margin 1)(clang_advice_win 1)(clang_define_win 1)(clang_del_win 1)(clang_info_win 1)(clang_mess_delay 50)(clang_mess_per_cycle 1)(clang_meta_win 1)(clang_rule_win 1)(clang_win_size 300)(coach 0)(coach_port 6001)(coach_w_referee 1)(connect_wait 300)(control_radius 2)(dash_angle_step 1)(dash_power_rate 0.006)(drop_ball_time 100)(effort_dec 0.005)(effort_dec_thr 0.3)(effort_inc 0.01)(effort_inc_thr 0.6)(effort_init 1)(effort_min 0.6)(extra_half_time 100)(extra_stamina 50)(fixed_teamname_l \"\")(fixed_teamname_r \"\")(forbid_kick_off_offside 1)(foul_cycles 5)(foul_detect_probability 0.5)(foul_exponent 10)(free_kick_faults 1)(freeform_send_period 20)(freeform_wait_period 600)(fullstate_l 0)(fullstate_r 0)(game_log_compression 0)(game_log_dated 1)(game_log_dir \"/root/logs\")(game_log_fixed 0)(game_log_fixed_name \"rcssserver\")(game_log_version 5)(game_logging 1)(game_over_wait 100)(goal_width 14.02)(goalie_max_moves 2)(golden_goal 0)(half_time 30)(hear_decay 1)(hear_inc 1)(hear_max 1)(illegal_defense_dist_x 16.5)(illegal_defense_duration 20)(illegal_defense_number 0)(illegal_defense_width 40.32)(inertia_moment 5)(keepaway 0)(keepaway_length 20)(keepaway_log_dated 1)(keepaway_log_dir \"./\")(keepaway_log_fixed 0)(keepaway_log_fixed_name \"rcssserver\")(keepaway_logging 1)(keepaway_start -1)(keepaway_width 20)(kick_off_wait 100)(kick_power_rate 0.027)(kick_rand 0.1)(kick_rand_factor_l 1)(kick_rand_factor_r 1)(kickable_margin 0.7)(landmark_file \"~/.rcssserver-landmark.xml\")(log_date_format \"%Y%m%d%H%M%S-\")(log_times 0)(max_back_tackle_power 0)(max_dash_angle 180)(max_dash_power 100)(max_goal_kicks 3)(max_tackle_power 100)(maxmoment 180)(maxneckang 90)(maxneckmoment 180)(maxpower 100)(min_dash_angle -180)(min_dash_power -100)(minmoment -180)(minneckang -90)(minneckmoment -180)(minpower -100)(nr_extra_halfs 2)(nr_normal_halfs 2)(offside_active_area_size 2.5)(offside_kick_margin 9.15)(olcoach_port 6002)(old_coach_hear 0)(pen_allow_mult_kicks 1)(pen_before_setup_wait 10)(pen_coach_moves_players 1)(pen_dist_x 42.5)(pen_max_extra_kicks 5)(pen_max_goalie_dist_x 14)(pen_nr_kicks 5)(pen_random_winner 0)(pen_ready_wait 10)(pen_setup_wait 70)(pen_taken_wait 150)(penalty_shoot_outs 1)(player_accel_max 1)(player_decay 0.4)(player_rand 0.1)(player_size 0.3)(player_speed_max 1.05)(player_speed_max_min 0.75)(player_weight 60)(point_to_ban 5)(point_to_duration 20)(port 6000)(prand_factor_l 1)(prand_factor_r 1)(profile 0)(proper_goal_kicks 0)(quantize_step 0.1)(quantize_step_l 0.01)(record_messages 0)(recover_dec 0.002)(recover_dec_thr 0.3)(recover_init 1)(recover_min 0.5)(recv_step 10)(red_card_probability 0)(say_coach_cnt_max 128)(say_coach_msg_size 128)(say_msg_size 10)(send_comms 0)(send_step 150)(send_vi_step 100)(sense_body_step 100)(side_dash_rate 0.4)(simulator_step 10)(slow_down_factor 1)(slowness_on_top_for_left_team 1)(slowness_on_top_for_right_team 1)(stamina_capacity 130600)(stamina_inc_max 45)(stamina_max 8000)(start_goal_l 0)(start_goal_r 0)(stopped_ball_vel 0.01)(synch_micro_sleep 1)(synch_mode 0)(synch_offset 60)(synch_see_offset 0)(tackle_back_dist 0)(tackle_cycles 10)(tackle_dist 2)(tackle_exponent 6)(tackle_power_rate 0.027)(tackle_rand_factor 2)(tackle_width 1.25)(team_actuator_noise 0)(team_l_start \"\")(team_r_start \"\")(text_log_compression 0)(text_log_dated 1)(text_log_dir \"/root/logs\")(text_log_fixed 0)(text_log_fixed_name \"rcssserver\")(text_logging 1)(use_offside 1)(verbose 0)(visible_angle 90)(visible_distance 3)(wind_ang 0)(wind_dir 0)(wind_force 0)(wind_none 0)(wind_rand 0)(wind_random 0))\x00",
		errCh,
	)
	close(errCh)

	if len(errCh) != 0 {
		for err := range errCh {
			fmt.Println(err)
		}
		t.Fail()
	}

	expectedData := ServerParams{
		AudioCutDist:              50,
		AutoMode:                  false,
		BackDashRate:              0.6,
		BackPasses:                true,
		BallAccelMax:              2.7,
		BallDecay:                 0.94,
		BallRand:                  0.05,
		BallSize:                  0.085,
		BallSpeedMax:              3,
		BallStuckArea:             3,
		BallWeight:                0.2,
		CatchBanCycle:             5,
		CatchProbability:          1,
		CatchableAreaL:            1.2,
		CatchableAreaW:            1,
		CKickMargin:               1,
		CLangAdviceWin:            1,
		CLangDefineWin:            1,
		CLangDelWin:               1,
		CLangInfoWin:              1,
		CLangMessDelay:            50,
		CLangMessPerCycle:         1,
		CLangMetaWin:              1,
		CLangRuleWin:              1,
		CLangWinSize:              300,
		Coach:                     false,
		CoachPort:                 6001,
		CoachWReferee:             true,
		ConnectWait:               300,
		ControlRadius:             2,
		DashAngleStep:             1,
		DashPowerRate:             0.006,
		DropBallTime:              100,
		EffortDec:                 0.005,
		EffortDecThr:              0.3,
		EffortInc:                 0.01,
		EffortIncThr:              0.6,
		EffortInit:                1,
		EffortMin:                 0.6,
		ExtraHalfTime:             100,
		ExtraStamina:              50,
		FixedTeamnameL:            "",
		FixedTeamnameR:            "",
		ForbidKickOffOffside:      true,
		FoulCycles:                5,
		FoulDetectProbability:     0.5,
		FoulExponent:              10,
		FreeKickFaults:            1,
		FreeformSendPeriod:        20,
		FreeformWaitPeriod:        600,
		FullstateL:                false,
		FullstateR:                false,
		GameLogCompression:        false,
		GameLogDated:              true,
		GameLogDir:                "/root/logs",
		GameLogFixed:              false,
		GameLogFixedName:          "rcssserver",
		GameLogVersion:            5,
		GameLogging:               true,
		GameOverWait:              100,
		GoalWidth:                 14.02,
		GoalieMaxMoves:            2,
		GoldenGoal:                false,
		HalfTime:                  30,
		HearDecay:                 1,
		HearInc:                   1,
		HearMax:                   1,
		IllegalDefenseDistX:       16.5,
		IllegalDefenseDuration:    20,
		IllegalDefenseNumber:      0,
		IllegalDefenseWidth:       40.32,
		InertiaMoment:             5,
		Keepaway:                  false,
		KeepawayLength:            20,
		KeepawayLogDated:          true,
		KeepawayLogDir:            "./",
		KeepawayLogFixed:          false,
		KeepawayLogFixedName:      "rcssserver",
		KeepawayLogging:           true,
		KeepawayStart:             -1,
		KeepawayWidth:             20,
		KickOffWait:               100,
		KickPowerRate:             0.027,
		KickRand:                  0.1,
		KickRandFactorL:           true,
		KickRandFactorR:           true,
		KickableMargin:            0.7,
		LandmarkFile:              "~/.rcssserver-landmark.xml",
		LogDateFormat:             "%Y%m%d%H%M%S-",
		LogTimes:                  false,
		MaxBackTacklePower:        0,
		MaxDashAngle:              180,
		MaxDashPower:              100,
		MaxGoalKicks:              3,
		MaxTacklePower:            100,
		MaxMoment:                 180,
		MaxMonitors:               -1,
		MaxNeckAng:                90,
		MaxNeckMoment:             180,
		MaxPower:                  100,
		MinDashAngle:              -180,
		MinDashPower:              -100,
		MinMoment:                 -180,
		MinNeckAng:                -90,
		MinNeckMoment:             -180,
		MinPower:                  -100,
		NrExtraHalfs:              2,
		NrNormalHalfs:             2,
		OffsideActiveAreaSize:     2.5,
		OffsideKickMargin:         9.15,
		OnlineCoachPort:           6002,
		OldCoachHear:              false,
		PenAllowMultKicks:         true,
		PenBeforeSetupWait:        10,
		PenCoachMovesPlayers:      true,
		PenDistX:                  42.5,
		PenMaxExtraKicks:          5,
		PenMaxGoalieDistX:         14,
		PenNrKicks:                5,
		PenRandomWinner:           false,
		PenReadyWait:              10,
		PenSetupWait:              70,
		PenTakenWait:              150,
		PenaltyShootOuts:          true,
		PlayerAccelMax:            1,
		PlayerDecay:               0.4,
		PlayerRand:                0.1,
		PlayerSize:                0.3,
		PlayerSpeedMax:            1.05,
		PlayerSpeedMaxMin:         0.75,
		PlayerWeight:              60,
		PointToBan:                5,
		PointToDuration:           20,
		Port:                      6000,
		PRandFactorL:              1,
		PRandFactorR:              1,
		Profile:                   0,
		ProperGoalKicks:           0,
		QuantizeStep:              0.1,
		QuantizeStepL:             0.01,
		RecordMessages:            false,
		RecoverDec:                0.002,
		RecoverDecThr:             0.3,
		RecoverInit:               1,
		RecoverMin:                0.5,
		RecvStep:                  10,
		RedCardProbability:        0,
		SayCoachCountMax:          128,
		SayCoachMsgSize:           128,
		SayMsgSize:                10,
		SendComms:                 0,
		SendStep:                  150,
		SendViStep:                100,
		SenseBodyStep:             100,
		SideDashRate:              0.4,
		SimulatorStep:             10,
		SlowDownFactor:            1,
		SlownessOnTopForLeftTeam:  true,
		SlownessOnTopForRightTeam: true,
		StaminaCapacity:           130600,
		StaminaIncMax:             45,
		StaminaMax:                8000,
		StartGoalL:                0,
		StartGoalR:                0,
		StoppedBallVel:            0.01,
		SynchMicroSleep:           1,
		SynchMode:                 false,
		SynchOffset:               60,
		SynchSeeOffset:            0,
		TackleBackDist:            0,
		TackleCycles:              10,
		TackleDist:                2,
		TackleExponent:            6,
		TacklePowerRate:           0.027,
		TackleRandFactor:          2,
		TackleWidth:               1.25,
		TeamActuatorNoise:         0,
		TeamLStart:                "",
		TeamRStart:                "",
		TextLogCompression:        false,
		TextLogDated:              true,
		TextLogDir:                "/root/logs",
		TextLogFixed:              false,
		TextLogFixedName:          "rcssserver",
		TextLogging:               true,
		UseOffside:                true,
		Verbose:                   false,
		VisibleAngle:              90,
		VisibleDistance:           3,
		WindAng:                   0,
		WindDir:                   0,
		WindForce:                 0,
		WindNone:                  false,
		WindRand:                  0,
		WindRandom:                0,
	}

	if sp != expectedData {
		fmt.Printf("\n%#v\n%#v\n", sp, expectedData)
		t.Fail()
	}
}
